<div class="page-header">
    <h1 *ngIf="!creationMode">{{lang.userModification}} <small>{{user.lastname}} {{user.firstname}}</small></h1>
    <h1 *ngIf="creationMode">{{lang.userCreation}} <small>{{user.lastname}} {{user.firstname}}</small></h1>
</div>
<div *ngIf="loading">
    <mat-spinner style="margin:auto;"></mat-spinner>
</div>
<div *ngIf="!loading" class="container-fluid">
    <div class="container-fluid">
        <mat-tab-group (selectChange)="initService()">
            <mat-tab label="Informations">    
                <div *ngIf="user.status == 'ABS'" class="text-warning" style="position: absolute;opacity: 0.1;font-size: 120px;transform: rotate(324deg);-webkit-transform: rotate(324deg);margin-left: 35%;margin-top: 90px;">{{user.status}}</div>    
                <div class="col-md-6 col-md-offset-3">
                    <div class="example-sidenav-content">
                        <form class="form-horizontal" (ngSubmit)="onSubmit()" #profileForm="ngForm">
                            <div class="form-group">
                                <div class="col-sm-12">
                                    <div class="pull-left image">
                                        <img src="img/maarch_box.png" class="img-circle avatar" alt="user profile image">
                                    </div>
                                    <div class="input-group">
                                        <!--<span class="input-group-addon"><i class="fa fa-user" aria-hidden="true"></i></span>-->
                                        <mat-form-field>
                                            <input matInput *ngIf="creationMode" type="text" title="{{lang.id}}" name="user_id" [(ngModel)]="user.userId" placeholder="{{lang.id}}"
                                                pattern="^[\w.@-]*$" required>

                                            <input matInput *ngIf="!creationMode" type="text" title="{{lang.id}}" value="{{user.user_id}}" placeholder="{{lang.id}}" disabled>
                                        </mat-form-field>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-5" style="font-weight:bold;">
                                    <mat-form-field>
                                        <input matInput type="text" id="lastname" name="lastname" title="{{lang.lastname}}" placeholder="{{lang.lastname}}" [(ngModel)]="user.lastname"
                                            required>
                                    </mat-form-field>
                                </div>
                                <div class="col-sm-5" style="font-weight:bold;">
                                    <mat-form-field>
                                        <input matInput type="text" id="firstname" name="firstname" title="{{lang.firstname}}" placeholder="{{lang.firstname}}" [(ngModel)]="user.firstname"
                                            required>
                                    </mat-form-field>
                                </div>
                                <div class="col-sm-2" style="font-style:italic;">
                                    <mat-form-field>
                                        <input matInput type="text" id="initials" name="initials" title="{{lang.initials}}" placeholder="{{lang.initials}}" [(ngModel)]="user.initials">
                                    </mat-form-field>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-12">
                                    <mat-form-field>
                                        <input matInput type="tel" id="phone" name="phone" title="{{lang.phoneNumber}}" placeholder="{{lang.phoneNumber}}" [(ngModel)]="user.phone"
                                            pattern="^(?:0|\+\d\d?\d?\s?)[1-9]([\.\-\s]?\d\d){4}([\.\-\s]?\d?\d?)$">
                                    </mat-form-field>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-12">
                                    <mat-form-field>
                                        <input matInput type="email" id="mail" name="mail" title="{{lang.email}}" placeholder="{{lang.email}}" [(ngModel)]="user.mail"
                                            pattern="[^@\s]+@[^@\s]+">
                                    </mat-form-field>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-12">
                                    <mat-form-field>
                                        <input matInput type="text" id="fingerprint" name="fingerprint" title="{{lang.fingerprint}}" placeholder="{{lang.fingerprint}}"
                                            [(ngModel)]="user.thumbprint">
                                    </mat-form-field>
                                </div>
                            </div>
                            <div class="form-group">
                                <div style="text-align:center;">
                                    <button *ngIf="creationMode" type="submit" class="btn btn-success" [disabled]="!profileForm.form.valid"><i class="fa fa-plus"></i> {{lang.save}}</button>
                                    <button *ngIf="!creationMode" type="submit" class="btn btn-success" [disabled]="!profileForm.form.valid"><i class="fa fa-save"></i> {{lang.update}}</button>
                                    <button *ngIf="user.status != 'ABS' && !creationMode" type="button" (click)="activateAbsence()" class="btn btn-warning"><i class="fa fa-plane"></i> {{lang.activateAbsence}}</button>
                                    <button *ngIf="user.status == 'ABS' && !creationMode" type="button" (click)="desactivateAbsence()" class="btn btn-success"><i class="fa fa-check"></i> {{lang.desactivateAbsence}}</button>
                                    <button type="button" *ngIf="!creationMode" (click)="resetPassword(user)" class="btn btn-default"><i class="fa fa-key"></i> {{lang.reinitPassword}}</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </mat-tab>
            <mat-tab *ngIf="!creationMode" label="Groupe(s)">
                <div class="col-md-6">
                    <div class="groupList">
                        <ul class="list-group col-md-12">
                            <li class="list-group-item" *ngFor="let group of user.allGroups">
                                <mat-slide-toggle id="{{group.group_id}}" color="primary" [checked]="group.disabled == true" (change)="toggleGroup(group)">{{group.group_desc}}</mat-slide-toggle>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-4 col-md-offset-1">
                    <div class="panel" *ngFor="let userGroup of user.groups" [ngClass]="[userGroup.primary_group == 'Y' ? 'panel-primary' : 'panel-default']">
                        <div class="panel-heading">
                            {{userGroup.group_desc}} <i *ngIf="userGroup.primary_group != 'Y'" class="fa fa-asterisk" aria-hidden="true"></i>
                        </div>
                        <div class="panel-body">
                            <mat-form-field>
                                <input matInput type="text" id="role" name="role" title="{{lang.role}}" placeholder="{{lang.role}}" [(ngModel)]="userGroup.role"
                                    (focusout)="updateGroup(userGroup)">
                            </mat-form-field>
                            <div class="col-md-12">
                                <ul class="list-unstyled">
                                    <li *ngFor="let basket of user.baskets; let i = index">
                                        <span *ngIf="basket.group_id == userGroup.group_id">
                                            <mat-slide-toggle [(ngModel)]="basket.enabled" color="primary">{{basket.basket_name}} <small class="text-danger" style="font-style:italic;" *ngIf="basket.userToDisplay != '' && basket.enabled">(Redirigé à {{basket.userToDisplay}})</small></mat-slide-toggle>
                                            <i (click)="toogleRedirect(basket)" *ngIf="basket.userToDisplay == '' && basket.enabled" matTooltip="Rediriger la banette à une personne lors de l'activation de l'absence" matTooltipPosition="above"
                                                class="fa fa-share-square text-primary" style="cursor:pointer;"></i>
                                            <sup><i style="cursor:pointer;" *ngIf="basket.userToDisplay != '' && basket.enabled" matTooltip="Supprimer la redirection" class="fa fa-times text-danger" aria-hidden="true" (click)="delBasketRedirection(i)"></i></sup>
                                            <div *ngIf="basket.userToDisplay == '' && basket.enabled" id="redirectUser_{{basket.group_id}}_{{basket.basket_id}}" style="display:none;">
                                                <md2-autocomplete
                                                    [items]="userList"
                                                    item-text="user_id"
                                                    item-value="user_id"
                                                    placeholder="utilisateur de redirection"
                                                    [(ngModel)]="basket.userToDisplay"
                                                    required
                                                    (change)="addBasketRedirection(i,basket)">
                                                </md2-autocomplete>
                                            </div>
                                        </span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="panel-footer">
                            <mat-form-field>
                                <input value="{{userGroup.maarch_comment}}" matInput type="text" title="{{lang.perimeter}}" placeholder="Ressource documentaire"
                                    disabled>
                            </mat-form-field>
                        </div>
                    </div>
                </div>
            </mat-tab>
            <mat-tab *ngIf="!creationMode" label="Entité(s)">
                <div class="col-md-6">
                    <mat-form-field>
                        <input matInput id="jstree_search" type="text" placeholder="Rechercher une entité">
                    </mat-form-field>
                    <div id="jstree"></div>
                </div>
                <div class="col-md-4 col-md-offset-1">
                    <div class="panel" *ngFor="let userEntity of user.entities" [ngClass]="[userEntity.primary_entity == 'Y' ? 'panel-primary' : 'panel-default']">
                        <div class="panel-heading">
                            {{userEntity.entity_label}} <i matTooltip="Passer en entité primaire" *ngIf="userEntity.primary_entity != 'Y'"
                                (click)="updatePrimaryEntity(userEntity)" class="fa fa-asterisk text-primary pull-right" style="cursor:pointer;"></i>
                        </div>
                        <div class="panel-body">
                            <mat-form-field>
                                <input matInput type="text" id="role" name="role" title="{{lang.role}}" placeholder="{{lang.role}}" [(ngModel)]="userEntity.user_role"
                                    (focusout)="updateEntity(userEntity)">
                            </mat-form-field>
                        </div>
                    </div>
                </div>
            </mat-tab>
            <mat-tab *ngIf="!creationMode" label="Signature(s)">
                <div class="col-md-6 col-md-offset-3">
                    <div class="form-group">
                        <button (click)="clickOnUploader('uploadSignFile')" matTooltip="taille de 2 mo maximum" class="form-control btn btn-sm btn-success"
                            style="width:auto;">
                                <i class="fa fa-plus"></i> Ajouter une signature
                            </button>
                    </div>
                    <div class="form-group">
                        <div class="row" style="margin-top:5px;display:none;">
                            <form (ngSubmit)="submitSignature()" #signatureForm="ngForm">
                                <div class="col-md-11">
                                    <input type="text" [(ngModel)]="signatureModel.label" id="signLabel" name="label" placeholder="{{lang.label}}" class="form-control"
                                        required>
                                    <div class="form-inline hide">
                                        <div class="form-group">
                                            <input type="file" name="files[]" id="uploadSignFile" (change)="uploadSignatureTrigger($event)" accept="image/*">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-1" style="margin-bottom:5px;">
                                    <button class="form-control btn btn-sm btn-success" type="submit" [disabled]="!signatureForm.form.valid || !signatureModel.size">
                                                    <i class="fa fa-plus"></i>
                                                </button>
                                </div>
                                <div [ngClass]="[signatureModel.size != '' ? 'col-md-10' : 'col-md-12']">
                                    <div class="upload-drop-zone" (click)="clickOnUploader('uploadSignFile')" style="cursor:pointer">
                                        {{lang.clickOn}} <i class="fa fa-upload fa-2x"></i> (
                                        < 2MB) </div>
                                    </div>
                                    <div class="col-md-2" *ngIf="signatureModel.size">
                                        <img id="signaturePreview" src="{{signatureModel.base64ForJs}}" alt="Invalid image" style="width: 100%;">
                                    </div>
                            </form>
                            </div>
                            <div id="signList">
                                <div *ngFor="let signature of user.signatures; let i = index" class="col-md-4" style="margin-bottom:10px;">
                                    <mat-card>
                                        <mat-card-header>
                                            <mat-card-title>
                                                <mat-form-field>
                                                    <input matInput type="text" [(ngModel)]="signature.signature_label" name="selectedSignatureLabel" placeholder="{{lang.label}}"
                                                        (focusout)="updateSignature(i)">
                                                </mat-form-field>
                                            </mat-card-title>
                                            <i class="fa fa-times text-danger" style="cursor:pointer;" (click)="deleteSignature(signature)"></i>
                                        </mat-card-header>


                                        <mat-card-content>
                                            <img src="{{signature.pathToSignatureOnTmp}}" alt="Signature" style="width:100%;height:60px;">
                                        </mat-card-content>
                                    </mat-card>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                        </div>
                    </div>
            </mat-tab>
            <mat-tab label="Historique">
                    <div class="col-md-12">
                <table id="hisotryTable" class="table table-hover table-condensed" [md2Data]="data | dataPipe : 'info' : search" #md2="md2DataTable" [sortBy]='event_date' [rowsPerPage]="10">
                    <thead>
                    <tr>
                        <td>
                            <md2-pagination></md2-pagination>
                        </td>
                        <td style="text-align:right;">
                            <mat-form-field>
                                    <input matInput placeholder="{{lang.filterBy}} : {{lang.desc}}" class="searchTable" [(ngModel)]="search" />
                            </mat-form-field>
                        </td>
                    </tr>
                    <tr>
                        <th md2SortBy="event_date">{{lang.date}}</th>
                        <th md2SortBy="info">{{lang.desc}}</th>
                    </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let history of md2.data">
                        <td style="vertical-align:middle;">{{history.event_date | date : "dd/MM/y HH:mm"}}</td>
                        <td style="vertical-align:middle;">{{history.info}}</td>
                    </tr>
                    </tbody>
                </table>
                    </div>
            </mat-tab>
        </mat-tab-group>
        </div>
    </div>